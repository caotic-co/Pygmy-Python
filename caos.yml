virtual_environment: "venv"

dependencies:
  nuitka: "~0.6.8"

tasks:

  install_openjdk:
    - echo "PygmyPython->INFO. Checking OpenJDK installation..."
    - mkdir -p dist/pygmypython
    - (test -d dist/pygmypython/openjdk) ||
      (
        echo "PygmyPython->INFO. Extracting OpenJDK..."
        && tar -xzf vendor/openjdk14/openjdk-14.0.1_linux-x64_bin.tar.gz --directory dist/pygmypython
        && mv dist/pygmypython/jdk-14.0.1 dist/pygmypython/openjdk
        && cp vendor/openjdk14/LICENSE dist/pygmypython/openjdk/LICENSE
      )
    - echo "PygmyPython->INFO. OpenJDK Installed"

  java_build:
    - mkdir -p dist/pygmypython/pygmypython_classes
    - ( export OPEN_JDK=dist/pygmypython/openjdk
        && echo "PygmyPython->INFO. Compiling PygmyPython Java Classes..."
        && export JUNIT_LIB="src/java/pygmypython/vendor/junit/junit-4.13.jar"
        && export HAMCREST_LIB="src/java/pygmypython/vendor/hamcrest/hamcrest-core-1.3.jar"
        && (
          $OPEN_JDK/bin/javac -cp $JUNIT_LIB:$HAMCREST_LIB -d dist/pygmypython/pygmypython_classes $(find src/java/pygmypython/ -name "*.java")
          || (echo "PygmyPython->ERROR. Compilation Failed" && exit 1)
        )
        && echo "PygmyPython->SUCCESS. Compilation Finished"
        && echo "PygmyPython->INFO. Executing Junit Test Suite..."
        && (
          $OPEN_JDK/bin/java -cp $JUNIT_LIB:$HAMCREST_LIB:dist/pygmypython/pygmypython_classes com.pygmypython.tests.PygmyPythonTestSuiteRunner
          || (echo "PygmyPython->ERROR. Junit Test Suite Failed" && exit 1)
        )
        && echo "PygmyPython->SUCCESS. All tests finished successfully"
        && rm -Rf dist/pygmypython/pygmypython_classes/com/pygmypython/tests
      )

  tests:
    - echo "PygmyPython->INFO. Executing Python Unit Tests..."
    - caos python -m unittest discover -v src/python/tests

  python_build:
    - echo "PygmyPython->INFO. Creating Linux binary..."
    - mkdir -p dist/pygmypython
    - (caos python -m nuitka --output-dir dist --remove-output --standalone --follow-imports pygmypython.py) ||
      (echo "PygmyPython->ERROR. There was a problem when creating the Linux binaries" && exit 1)
    - mv dist/pygmypython.dist/* dist/pygmypython
    - rm -Rf dist/pygmypython.dist/
    - chmod +x dist/pygmypython/pygmypython
    - echo "PygmyPython->SUCCESS. Binary created"

  build:
    - install_openjdk
    - java_build
    - caos run tests
    - python_build

