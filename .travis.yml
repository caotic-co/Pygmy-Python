dist: bionic
language: python
python: 3.8

addons:
  apt:
    packages:
      - chrpath


install:
  - pip install caos~=2.0


script:
  - caos init
  - ln -s $(which pip) venv/bin/pip # This is a hack for Travis CI that adds the missing pip binary
  - caos update
  - caos run tests
  - caos run build
  - cd dist && zip -r pygmypython.zip pygmypython


before_deploy:
  - git config --global --add user.name $GITHUB_USER_NAME
  - git config --global --add user.password $GITHUB_OAUTH_TOKEN
  - export GIT_TAG=$(python -c 'from pygmypython_core import __version__; print("v{}".format(__version__))')
  - (git push --delete origin $GIT_TAG && echo "TravisCi-INFO-Tag '$GIT_TAG' will be overwritten") || echo "TravisCi-INFO-New Tag '$GIT_TAG' will be created"
  - git tag $GIT_TAG
  - git push origin --tags

deploy:
  skip_cleanup: true
  provider: releases
  api_key: $GITHUB_OAUTH_TOKEN
  file: "dist/pygmypython.zip"
  on:
    branch: master
    tags: false

