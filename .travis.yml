language: python
python: 3.8

addons:
  apt:
    packages:
      - chrpath


install:
  - pip install caos~=2.0


script:
  - caos init
  - ln -s $(which pip) venv/bin/pip # This is a hack for Travis CI that adds the missing pip binary
  - caos update
  - caos run tests
  - caos run build
  - cd dist && zip -r pygmypython.zip pygmypython


before_deploy:
  - git config --local user.name "Travis CI"
  - git config --local user.email "builds@travis-ci.com"
  - git tag $(python -c 'from pygmypython_core import __version__; print("v{}".format(__version__))')

deploy:
  skip_cleanup: true
  provider: releases
  api_key: $GITHUB_OAUTH_TOKEN
  file: "dist/pygmypython.zip"
  on:
    branch: master
    tags: false

